__NUXT_JSONP__("/", (function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F){return {data:[{posts:[{_id:"633f007e2c3aa4b59313ccd1",_sys:{raw:{createdAt:"2022-10-06T16:21:18.615Z",updatedAt:l,firstPublishedAt:s,publishedAt:l},createdAt:s,updatedAt:l},title:"FirebaseのCIデプロイが突然落ちるようになった",slug:"firebase-github-actions-error",description:"本サイトの環境はFirebaseにデプロイしており、GitHub Actionsで自動でデプロイするようにしていますが、突然エラーが発生して落ちるようになりました。",meta:{title:"FirebaseのCIデプロイが突然落散るようになった",description:a,ogImage:k},body:"\u003Ch2\u003Eエラー発生\u003C\u002Fh2\u003E\n\u003Cp\u003E本サイトの環境はFirebaseにデプロイしており、GitHub Actionsで自動でデプロイするようにしていますが、突然エラーが発生して落ちるようになりました。\u003C\u002Fp\u003E\n\u003Ch2\u003Eエラー内容\u003C\u002Fh2\u003E\n\u003Cp\u003Eエラー内容は以下です。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-log\"\u003EError: Failed to list functions for *******\n\nThe process '\u002Fusr\u002Flocal\u002Fbin\u002Fnpx' failed with exit code 1\nError: The process '\u002Fusr\u002Flocal\u002Fbin\u002Fnpx' failed with exit code 1\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eさすがにさっきのだけじゃあ何もわからないので少し探してみる。\u003C\u002Fp\u003E\n\u003Ch3\u003Eエラー1\u003C\u002Fh3\u003E\n\u003Cp\u003E調べると以下のエラーが発生していました。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-log\"\u003E[2022-10-06T16:20:32.871Z] [functions] HTTP Error: 403, Cloud Functions API has not been used in project 700***** before or it is disabled. Enable it by visiting \n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eエラーの少し前になんかそれっぽいことが書いてありますね。「Cloud Functions API」とやらが有効化されていないから有効化しろとのことです。\u003C\u002Fp\u003E\n\u003Cp\u003Eとりあえず、GCPにログインして、対象のプロジェクトで「Cloud Functions API」を有効化します。\u003C\u002Fp\u003E\n\u003Ch3\u003Eエラー2\u003C\u002Fh3\u003E\n\u003Cp\u003E先ほどのエラーはなくなりましたが、今度は以下のようなエラーが発生。（もともとあったかもしんない）\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-log\"\u003EError: HTTP Error: 403, Permission 'cloudfunctions.functions.list' denied on 'projects\u002F**********\u002Flocations\u002F-\u002Ffunctions'\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Efirebaseのバグっぽい？調べると以下のIssueにあたりました。\u003Cbr\u003E\n\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FFirebaseExtended\u002Faction-hosting-deploy\u002Fissues\u002F203\"\u003Ehttps:\u002F\u002Fgithub.com\u002FFirebaseExtended\u002Faction-hosting-deploy\u002Fissues\u002F203\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E一番評価がありそうな解決策を試してみます。\u003Cbr\u003E\n\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FFirebaseExtended\u002Faction-hosting-deploy\u002Fissues\u002F203#issuecomment-1127732956\"\u003Ehttps:\u002F\u002Fgithub.com\u002FFirebaseExtended\u002Faction-hosting-deploy\u002Fissues\u002F203#issuecomment-1127732956\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E方法は以下の通りです\u003C\u002Fp\u003E\n\u003Col\u003E\n\u003Cli\u003E「IAMと管理 &gt; IAM」に移動して\u003Ccode\u003Egithub-actions\u003C\u002Fcode\u003Eから始まるアカウントを探す\u003C\u002Fli\u003E\n\u003Cli\u003E鉛筆マークで「別のロールを追加」から、\u003Ccode\u003ECloud Functions 閲覧者\u003C\u002Fcode\u003Eを追加\u003C\u002Fli\u003E\n\u003Cli\u003E正しいプロジェクトにいるか念のために確認\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\u003Cp\u003E保存してGithubActionsを再実行したところ、うまく動作しました。\u003C\u002Fp\u003E\n\u003Ch2\u003E解決策・まとめ\u003C\u002Fh2\u003E\n\u003Cp\u003Eどうやら、GCP関連の権限不足だった模様です。\u003Cbr\u003E\nどうしていきなり発生したのかはわかりません。本日（2022\u002F10\u002F6）にfirebaseから規約変更などのメールはありましたがそれが原因とは思えません。（GithubのIssueは数か月前のもの）\u003Cbr\u003E\n利用からちょうど３か月経とうかというところなので、無料期間外だからでしょうか。\u003C\u002Fp\u003E\n\u003Cp\u003Eまぁ、よくわからんけど解決したからヨシ！\u003C\u002Fp\u003E\n\u003Cp\u003E2022\u002F10\u002F7 追記\u003Cbr\u003E\nIssueを追ってみたら、昨日あたりからこのエラーが発生したようです。\u003Cbr\u003E\n具体的な原因についてはわかりませんでした。\u003C\u002Fp\u003E\n\u003Cp\u003E今回の問題は、以下の二つの操作で解決できました。\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Ccode\u003ECloud Functions API\u003C\u002Fcode\u003Eの有効化\u003C\u002Fli\u003E\n\u003Cli\u003Eアカウントのロール追加\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n",image:{_id:t,altText:a,description:a,fileName:u,fileSize:v,fileType:c,height:w,metadata:{},src:x,title:a,width:d},author:{_id:m,_sys:{raw:{createdAt:b,updatedAt:n,firstPublishedAt:b,publishedAt:e},createdAt:b,updatedAt:e},name:f,slug:f,biography:o,image:k},tags:[{_id:"633f0f082c3aa4b593186c2d",_sys:{raw:{createdAt:g,updatedAt:g,firstPublishedAt:g,publishedAt:g},createdAt:g,updatedAt:g},name:"Firebase",slug:"firebase",image:{_id:t,altText:a,description:a,fileName:u,fileSize:v,fileType:c,height:w,metadata:{},src:x,title:a,width:d}},{_id:"633f0f262c3aa4b593186ec4",_sys:{raw:{createdAt:h,updatedAt:h,firstPublishedAt:h,publishedAt:h},createdAt:h,updatedAt:h},name:"Github Actions",slug:"github-actions",image:{_id:"633f0f1e2c3aa4b593186e62",altText:a,description:a,fileName:"github-actions.svg",fileSize:3237,fileType:c,height:d,metadata:{},src:"https:\u002F\u002Fik.imagekit.io\u002Fmasahikoproject\u002F34b7fbad-72d9-4a2a-b7b4-7d3bfd1bc892\u002Fgithub-actions.svg",title:a,width:d}}]},{_id:"632f56d68834f719d021b2d6",_sys:{raw:{createdAt:p,updatedAt:q,firstPublishedAt:p,publishedAt:q},createdAt:p,updatedAt:q},title:y,slug:"vue-3-vue-test-utils-chatjs",description:"はじめはVuexのストアが問題で発生していると思い込んで、ひたすらモック作成に取り組んでいたけど一向にエラー文が変わらない絶望 そんなこんなで、色々いじくりまわしてるとあることに気づいた",meta:{title:y,description:"というのも、mountedでは子コンポーネント全てをマウントしたことは保証しないらしく、すべてのコンポーネントがマウントされているとは限らないそうです。公式ドキュメントにも普通に書いてあったので参考に載っけときます。",ogImage:k},body:"\u003Cp\u003Eあまり気力がないのでかなり端折って書きます。\u003C\u002Fp\u003E\n\u003Ch2\u003E環境\u003C\u002Fh2\u003E\n\u003Cul\u003E\n\u003Cli\u003Evue@3.2.19\u003C\u002Fli\u003E\n\u003Cli\u003Evuex@4.0.2\u003C\u002Fli\u003E\n\u003Cli\u003Echart.js@2.9.4\u003C\u002Fli\u003E\n\u003Cli\u003E@vue\u002Ftest-utils@2.0.0-rc.15\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cp\u003Eここで関係のなさそうな一般ライブラリが入っているってことは、つまりそういうことなんです。\u003C\u002Fp\u003E\n\u003Ch2\u003E問題の部分\u003C\u002Fh2\u003E\n\u003Cp\u003E本当ならもっと長いけど、問題となった部分はここだけ\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode\u003Esrc\u002Fcomponents\u002FChart.vue\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-html\"\u003E&lt;template&gt;\n  &lt;div class=&quot;chart&quot;&gt;\n    &lt;canvas id=&quot;myChart&quot;&gt;&lt;\u002Fcanvas&gt;\n  &lt;\u002Fdiv&gt;\n&lt;\u002Ftemplate&gt;\n\n&lt;script&gt;\nimport Chart from &quot;chart.js&quot;;\nimport &quot;chartjs-plugin-colorschemes&quot;;\n\nexport default {\n  ...略\n  methods: {\n    drawLineChart() {\n      const ctx = document.getElementById(&quot;myChart&quot;);\n\n      \u002F\u002F グラフの作成及び設定を指定する\n      window.populationChart = new Chart(ctx, {\n\t    ...略\n\t  });\n    },\n  },\n  mounted() {\n    \u002F\u002F グラフの作成\n    this.drawLineChart();\n  },\n};\n&lt;\u002Fscript&gt;\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003C\u002Fbr\u003E\n\u003Cp\u003E\u003Ccode\u003Etests\u002Funit\u002FChart.spec.js\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-js\"\u003Eimport { shallowMount } from &quot;@vue\u002Ftest-utils&quot;;\nimport Chart from &quot;@\u002Fcomponents\u002FChart.vue&quot;;\n\n\ntest(&quot;Chart&quot;, () =&gt; {\n  const state = {\n\t...略\n  }\n\n  const $store = {\n\t...略\n  }\n\n  const wrapper = shallowMount(Chart, {\n    global: {\n      mocks: {\n        $store\n      }\n    }\n  })\n});\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch2\u003E何が起きたのか・エラー内容\u003C\u002Fh2\u003E\n\u003Cp\u003Eなんと！こんな素敵なエラーが出てきました✨✨\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-log\"\u003EFAIL  tests\u002Funit\u002FPopulationChart.spec.js\n ● Console\n\nconsole.warn node_modules\u002F@vue\u002Fruntime-core\u002Fdist\u002Fruntime-core.cjs.js:6465\n  [Vue warn]: Unhandled error during execution of mounted hook \n\tat &lt;PopulationChart ref=&quot;VTU_COMPONENT&quot; &gt; \n\tat &lt;VTUROOT&gt;\n\n ● \n\n  TypeError: Cannot read property 'length' of null\n  \n  ...略\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eな...何を言っているのかわからねーと思うが、おれも何をされたのかわからなかった...\u003C\u002Fp\u003E\n\u003Cp\u003Eどこのことを言っているの分からなかったし、時間をかけて調べても何にも出てこない、マジで\u003C\u002Fp\u003E\n\u003Cp\u003EはじめはVuexのストアが問題で発生していると思い込んで、ひたすらモック作成に取り組んでいたけど一向にエラー文が変わらない絶望...\u003C\u002Fp\u003E\n\u003Cp\u003Eそんなこんなで、色々いじくりまわしてるとあることに気づいた\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-log\"\u003ETypeError: Cannot read property 'length' of null\n\n  at Object.acquireContext (node_modules\u002Fchart.js\u002Fdist\u002FChart.js:7756:19)\n  at Chart.construct (node_modules\u002Fchart.js\u002Fdist\u002FChart.js:9324:26)\n  at new Chart (node_modules\u002Fchart.js\u002Fdist\u002FChart.js:9311:7)\n  at Proxy.drawLineChart (src\u002Fcomponents\u002FPopulationChart.vue:760:32)\n  at Proxy.mounted (src\u002Fcomponents\u002FPopulationChart.vue:816:10)\n  ...略\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eさっきは略していましたが、よく見ると\u003Ccode\u003EChart\u003C\u002Fcode\u003Eやら\u003Ccode\u003EContext\u003C\u002Fcode\u003Eやら書いてある...\u003C\u002Fp\u003E\n\u003Cp\u003Eもしかしてもしかするとこの\u003Ccode\u003EChart.js\u003C\u002Fcode\u003Eが問題のパターン？と思い、たくさん調べてみましたよ。\u003C\u002Fp\u003E\n\u003Cp\u003Eライブラリの問題部分を読んでみると、どうやらコンストラクタの引数のcanvasエレメントが問題だった。さらに調べた結果、canvasが表示されきってないとかどうとかで読み込めなかったらしい。／(^o^)＼ﾅﾝﾃｺｯﾀｲ\u003C\u002Fp\u003E\n\u003Ch2\u003E問題の解決方法\u003C\u002Fh2\u003E\n\u003Cp\u003Eということで、数時間かけて問題に対処した結果、コードの修正部分は以下の通りです‼‼‼‼\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode\u003Esrc\u002Fcomponents\u002FChart.vue\u003C\u002Fcode\u003Eの\u003Ccode\u003Emounted\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-js\"\u003E  mounted() {\n    \u002F\u002F this.$nextTickで囲むだけ‼‼‼‼‼‼ 簡単だね‼\n    this.$nextTick(function () {\n      \u002F\u002F グラフの作成\n      this.drawLineChart();\n    });\n  },\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eそう、ここだけ‼\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode\u003Ecanvas\u003C\u002Fcode\u003Eがマウントされきっていないため、\u003Ccode\u003E$nextTick\u003C\u002Fcode\u003Eを使ってすべてのコンポーネントがマウントされるのを待ったらいけました。\u003C\u002Fp\u003E\n\u003Cp\u003Eというのも、\u003Ccode\u003Emounted\u003C\u002Fcode\u003Eでは子コンポーネント全てをマウントしたことは保証しないらしく、すべてのコンポーネントがマウントされているとは限らないそうです。公式ドキュメントにも普通に書いてあったので参考に載っけときます。\u003C\u002Fp\u003E\n\u003Ch2\u003Eおわりに\u003C\u002Fh2\u003E\n\u003Cp\u003E数時間悩んだ結果2行追加で解決でつらいよ、俺の努力はいったい...\u003C\u002Fp\u003E\n\u003Cp\u003E／(^o^)＼ﾅﾝﾃｺｯﾀｲ\u003C\u002Fp\u003E\n\u003Cp\u003E深夜テンションで書きましたのでもう寝ます( ˘ω˘)ｽﾔｧ\u003C\u002Fp\u003E\n\u003Cp\u003E誤字脱字はゆるしてください\u003C\u002Fp\u003E\n\u003Ch2\u003E参考\u003C\u002Fh2\u003E\n\u003Cblockquote\u003E\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fqiita.com\u002Fchan_kaku\u002Fitems\u002F7f3233053b0e209ef355#mounted\"\u003EVueのライフサイクルを完全に理解した - Qiita\u003C\u002Fa\u003E\u003Cbr\u003E\n\u003Ca href=\"https:\u002F\u002Fjp.vuejs.org\u002Fv2\u002Fapi\u002Findex.html#mounted\"\u003EAPI — Vue.js\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003C\u002Fblockquote\u003E\n",image:{_id:z,altText:a,description:a,fileName:A,fileSize:B,fileType:c,height:C,metadata:{},src:D,title:a,width:d},author:{_id:m,_sys:{raw:{createdAt:b,updatedAt:n,firstPublishedAt:b,publishedAt:e},createdAt:b,updatedAt:e},name:f,slug:f,biography:o,image:k},tags:[{_id:"63161d44d59cbbc5fa89a71c",_sys:{raw:{createdAt:i,updatedAt:i,firstPublishedAt:i,publishedAt:i},createdAt:i,updatedAt:i},name:"Vue.js",slug:"vuejs",image:{_id:z,altText:a,description:a,fileName:A,fileSize:B,fileType:c,height:C,metadata:{},src:D,title:a,width:d}}]}],notes:[{_id:"636170453548a57ba116761e",_sys:{raw:{createdAt:"2022-11-01T19:15:17.916Z",updatedAt:r,firstPublishedAt:E,publishedAt:r},customOrder:3,createdAt:E,updatedAt:r},title:"GCSにアップロードしたPDFのリンクが勝手にダウンロードしてしまう",slug:"gcs-pdf-open-another-tab",body:"\u003Ch2\u003E問題\u003C\u002Fh2\u003E\n\u003Cp\u003EGoogleCloudStorageでアップロードしたpdfのリンクをクリックするとPDF viewerが開かずにダウンロードされる。\u003C\u002Fp\u003E\n\u003Ch2\u003E原因\u003C\u002Fh2\u003E\n\u003Cp\u003Eファイルアップロード時に、\u003Ccode\u003EContent-Type\u003C\u002Fcode\u003Eを明示的に指定しないと、\u003Ccode\u003EContent-Type\u003C\u002Fcode\u003Eが勝手に\u003Ccode\u003Eapplication\u002Foctet-stream\u003C\u002Fcode\u003Eとなってしまい、ファイルの種類が分からないが故に、ダウンロードしてしまうようです。\u003C\u002Fp\u003E\n\u003Cp\u003EGoogle Cloud Storageで「種類」をしていすることでPDF Viewerで開くことができます。\u003C\u002Fp\u003E\n\u003Ch2\u003E解決策\u003C\u002Fh2\u003E\n\u003Cp\u003Eプログラムで明示的にContentTypeを指定します。\u003C\u002Fp\u003E\n\u003Ch3\u003EGCSから設定する場合\u003C\u002Fh3\u003E\n\u003Cp\u003Eオブジェクトの詳細から、「メタデータを編集」をクリックします。その際に開くモーダルウインドウでContent-Typeを指定します。\u003C\u002Fp\u003E\n\u003Ch3\u003EC#の例\u003C\u002Fh3\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-cs\"\u003Estorage.UploadObject(bucketName, objectName, contentType, FileSource);\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch3\u003Eコマンド\u003C\u002Fh3\u003E\n\u003Cp\u003Eすでにアップロードしているファイルは、以下のコマンドで一括変更が可能\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003Egsutil ls &quot;gs:\u002F\u002Fmy-bucket-name\u002Ffolder-name\u002F&quot; \\\n| grep &quot;\\.pdf&quot; \\\n| xargs -I {} gsutil setmeta -h &quot;Content-Type: application\u002Fpdf&quot; &quot;{}&quot;\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n",author:{_id:m,_sys:{raw:{createdAt:b,updatedAt:n,firstPublishedAt:b,publishedAt:e},createdAt:b,updatedAt:e},name:f,slug:f,biography:o,image:k},tags:[{_id:"636172993548a57ba116a49e",_sys:{raw:{createdAt:j,updatedAt:j,firstPublishedAt:j,publishedAt:j},customOrder:13,createdAt:j,updatedAt:j},name:"Google Cloud Storage",slug:"google-cloud-storage",image:{_id:"6361727b3548a57ba116a3b5",altText:a,description:a,fileName:"cloud_storage.svg",fileSize:745,fileType:c,height:F,metadata:{},src:"https:\u002F\u002Fik.imagekit.io\u002Fmasahikoproject\u002F966a47dd-970a-4d41-a073-d8515f12d909\u002Fcloud_storage.svg",title:a,width:F}}]}]}],fetch:{},mutations:void 0}}("","2021-12-01T08:43:09.433Z","image\u002Fsvg+xml",256,"2022-08-21T16:40:12.899Z","masa","2022-10-06T17:23:20.446Z","2022-10-06T17:23:50.965Z","2022-09-05T16:01:08.024Z","2022-11-01T19:25:13.490Z",null,"2022-10-07T07:46:38.074Z","61a7359d8131ac001847fbb4","2022-08-21T16:42:17.357Z","\u003Cp\u003EWebエンジニアです。\u003C\u002Fp\u003E\u003Cp\u003Eよろしくお願いします。\u003C\u002Fp\u003E","2022-09-24T19:13:26.484Z","2022-10-08T08:14:55.576Z","2022-11-01T19:27:41.821Z","2022-10-06T17:08:31.771Z","633f00f52c3aa4b593141c01","firebase.svg",2608,351,"https:\u002F\u002Fik.imagekit.io\u002Fmasahikoproject\u002F819f9f03-7710-4edc-b936-2507fe7e3a9a\u002Ffirebase.svg","Vue3のVue Test Utils で地獄をみた（Chart.js部門）","63161d23d59cbbc5fa89a677","vue.svg",569,221,"https:\u002F\u002Fstorage.googleapis.com\u002Fp_6302578c3183a77882ff85f3\u002F4cc2a9dc-036c-4164-9c6e-ad2de68644c0%2Fvue.svg","2022-11-01T19:25:21.280Z",24)));